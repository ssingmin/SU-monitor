<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Arduino Monitor</title>
    <style>
        /* === ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ëª¨ë°”ì¼ ìµœì í™”) === */
        * { box-sizing: border-box; }
        body { margin: 0; padding: 10px; font-family: 'Segoe UI', sans-serif; background: #f4f6f9; height: 100vh; display: flex; flex-direction: column; gap: 10px; }
        
        /* ëª¨ë°”ì¼ì—ì„œ ë³´ê¸° ì¢‹ê²Œ í°íŠ¸/ë ˆì´ì•„ì›ƒ ì¡°ì • */
        .box { background: white; border: 1px solid #ccc; border-radius: 8px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .disabled-state { filter: grayscale(100%); opacity: 0.6; pointer-events: none; }
        
        .section-graph { flex: 1; position: relative; min-height: 200px; }
        .section-table { flex: 1; display: flex; flex-direction: column; overflow: hidden; gap: 10px; } 
        .table-scroll { flex: 1; overflow: auto; border: 1px solid #ddd; border-radius: 4px; }
        
        table { width: 100%; border-collapse: collapse; text-align: center; white-space: nowrap; }
        th, td { border: 1px solid #ccc; padding: 8px; font-size: 14px; font-weight: 600; }
        thead th { background: #eaeff5; position: sticky; top: 0; z-index: 10; }
        td:first-child, th:first-child { background: #e9ecef; font-weight: bold; position: sticky; left: 0; z-index: 5; }
        
        .active-cell { background-color: #fff3cd !important; border: 2px solid #ffc107 !important; }

        /* í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
        .stopwatch-panel {
            background-color: #222; padding: 5px; border-radius: 6px; border: 2px solid #444;
            height: 40px; display: flex; align-items: center; position: relative; overflow: hidden;
        }
        .progress-bar {
            height: 100%; width: 0%; background-color: #0066ff; box-shadow: 0 0 10px #0066ff;
            transition: width 0.1s linear;
        }
        .progress-bar.resizing { transition: none !important; }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .section-footer { 
            display: flex; flex-direction: column; gap: 10px; padding-bottom: 10px;
        }
        .footer-row { display: flex; gap: 10px; justify-content: space-between; align-items: center; }
        
        /* ì¤‘ì•™ ìƒíƒœ ë©”ì‹œì§€ */
        .status-panel { 
            display: flex; gap: 10px; align-items: center; justify-content: center; 
            background: #fff; border: 1px solid #ccc; border-radius: 4px; 
            padding: 10px; width: 100%; font-weight: bold; color: #555;
        }
        .status-dot { width: 12px; height: 12px; background-color: #ccc; border-radius: 50%; display: inline-block; }
        .status-dot.active { background-color: #00ff00; box-shadow: 0 0 8px #00ff00; }
        
        .mini-timer { font-family: 'Courier New', monospace; font-size: 18px; color: #555; min-width: 80px; text-align: right; }

        button { 
            height: 50px; padding: 0 15px; font-size: 16px; font-weight: bold; 
            cursor: pointer; border: 1px solid #999; background: white; border-radius: 6px; flex: 1;
        }
        .btn-connect { background-color: #007bff; color: white; border: none; }
        .btn-disconnect { background-color: #6c757d; color: white; border: none; }
        .btn-export { background-color: #17a2b8; color: white; border: none; }

    </style>
</head>
<body>

    <div class="box section-graph" id="graphArea">
        <canvas id="myChart"></canvas>
    </div>

    <div class="box section-table" id="tableArea">
        <div class="table-scroll">
            <table id="dataTable">
                <thead><tr><th>ID</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th></tr></thead>
                <tbody>
                    <tr id="timeRow"><td>Time</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
                    <tr id="dataRow"><td>Pulse</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
                </tbody>
            </table>
        </div>
        <div class="stopwatch-panel"><div id="progressBar" class="progress-bar"></div></div>
    </div>

    <div class="section-footer">
        <div class="status-panel">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">ì¥ì¹˜ ì—°ê²° ëŒ€ê¸° ì¤‘...</span>
            <div style="flex:1"></div>
            <span id="miniTimerDisplay" class="mini-timer">0 ms</span>
        </div>

        <div class="footer-row">
            <button id="btnConnect" class="btn-connect">ğŸ”Œ ì—°ê²°í•˜ê¸° (USB)</button>
            <button id="btnExport" class="btn-export">ğŸ’¾ ì €ì¥</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // === 1. ì°¨íŠ¸ ì„¤ì • ===
        const ctx = document.getElementById('myChart');
        Chart.defaults.font.size = 14; 
        const myChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: ['1','2','3','4','5','6','7','8','9','10'], datasets: [{ label: 'Pulse Width (ms)', data: [0,0,0,0,0,0,0,0,0,0], backgroundColor: '#4472C4' }] },
            options: { responsive: true, maintainAspectRatio: false, animation: { duration: 0 } }
        });

        // === 2. ì „ì—­ ë³€ìˆ˜ ===
        let port, reader, inputDone;
        let outputStream, inputStream;
        let isConnected = false;
        let logBuffer = [];
        let displayData = [0,0,0,0,0,0,0,0,0,0];
        let displayTimes = ['-','-','-','-','-','-','-','-','-','-'];
        let currentIndex = 0;
        let serialBuffer = ""; // ë°ì´í„° ì¡°ê° ëª¨ìŒìš©

        // íƒ€ì´ë¨¸ ê´€ë ¨
        let startTime = 0;
        let timerInterval = null;
        let currentMaxScale = 2000;
        const progressBar = document.getElementById('progressBar');
        const miniTimerDisplay = document.getElementById('miniTimerDisplay');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        // === 3. Web Serial API ì—°ê²° ë¡œì§ ===
        async function connectSerial() {
            // ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸
            if (!("serial" in navigator)) {
                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” Web Serial APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í¬ë¡¬ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
                return;
            }

            try {
                // í¬íŠ¸ ìš”ì²­ (ì‚¬ìš©ì ì„ íƒ íŒì—…)
                port = await navigator.serial.requestPort();
                
                // í¬íŠ¸ ì—´ê¸° (BaudRate 115200 ì„¤ì •)
                await port.open({ baudRate: 115200 });

                // ìŠ¤íŠ¸ë¦¼ ì„¤ì •
                const textDecoder = new TextDecoderStream();
                inputDone = port.readable.pipeTo(textDecoder.writable);
                reader = textDecoder.readable.getReader();

                isConnected = true;
                updateUIState(true);
                readLoop(); // ë°ì´í„° ì½ê¸° ì‹œì‘

            } catch (err) {
                console.error("ì—°ê²° ì—ëŸ¬:", err);
                alert("ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + err.message);
                updateUIState(false);
            }
        }

        async function disconnectSerial() {
            if (reader) {
                await reader.cancel();
                await inputDone.catch(() => {});
                reader = null;
                inputDone = null;
            }
            if (port) {
                await port.close();
                port = null;
            }
            isConnected = false;
            updateUIState(false);
        }

        // === 4. ë°ì´í„° ì½ê¸° ë° íŒŒì‹± (ì„œë²„ ë¡œì§ì„ ì—¬ê¸°ë¡œ ì´ì‹) ===
        async function readLoop() {
            while (true) {
                const { value, done } = await reader.read();
                if (done) {
                    reader.releaseLock();
                    break;
                }
                
                if (value) {
                    // 1. ì¡°ê°ë‚œ ë°ì´í„° ë²„í¼ì— ë¶™ì´ê¸°
                    serialBuffer += value;

                    // 2. ì¤„ë°”ê¿ˆ í™•ì¸
                    if (serialBuffer.includes('\n')) {
                        const lines = serialBuffer.split(/\r?\n/);
                        serialBuffer = lines.pop(); // ëœ ì˜¨ ì¡°ê°ì€ ë‚¨ê²¨ë‘ 

                        for (const line of lines) {
                            if (!line.trim()) continue;
                            
                            // === íŒŒì‹± ë¡œì§ (ì„œë²„ì—ì„œ ê°€ì ¸ì˜´) ===
                            
                            // [FALL] -> ì‹œì‘ (Active Low)
                            if (line.includes('[FALL]')) {
                                startMeasurementUI();
                            }

                            // Pulse Width -> ì¢…ë£Œ ë° ê°’ ì—…ë°ì´íŠ¸
                            const pulseMatch = line.match(/Pulse Width:\s*(\d+)/);
                            if (pulseMatch) {
                                const realValue = parseInt(pulseMatch[1]);
                                stopMeasurementUI(realValue);
                            }
                        }
                    }
                }
            }
        }

        // === 5. UI ì œì–´ (ê¸°ì¡´ ë™ì¼) ===
        function updateUIState(connected) {
            const btn = document.getElementById('btnConnect');
            if (connected) {
                btn.textContent = "âŒ ì—°ê²° í•´ì œ";
                btn.className = "btn-disconnect";
                btn.onclick = disconnectSerial;
                statusText.textContent = "ì‹ í˜¸ ëŒ€ê¸° ì¤‘...";
                resetUI();
            } else {
                btn.textContent = "ğŸ”Œ ì—°ê²°í•˜ê¸° (USB)";
                btn.className = "btn-connect";
                btn.onclick = connectSerial;
                statusText.textContent = "ì¥ì¹˜ ì—°ê²° ëŒ€ê¸° ì¤‘...";
                statusDot.classList.remove('active');
            }
        }

        function startMeasurementUI() {
            if (startTime !== 0) return;
            startTime = Date.now();
            currentMaxScale = 2000;
            statusDot.classList.add('active'); // ì´ˆë¡ ë¶ˆ ì¼œê¸°
            statusText.textContent = "ì¸¡ì • ì¤‘... (ëˆ„ë¦„)";
            
            progressBar.classList.add('resizing');
            progressBar.style.width = '0%';
            void progressBar.offsetWidth; 
            progressBar.classList.remove('resizing'); 
            progressBar.style.backgroundColor = "#0066ff";
            miniTimerDisplay.style.color = "#0066ff";
            
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                if (elapsed > currentMaxScale) { currentMaxScale *= 2; progressBar.classList.add('resizing'); }
                else { progressBar.classList.remove('resizing'); }
                let percent = (elapsed / currentMaxScale) * 100;
                if(percent > 100) percent = 100;
                progressBar.style.width = percent + '%';
                miniTimerDisplay.innerText = elapsed + " ms";
            }, 16);
        }

        function stopMeasurementUI(finalValue) {
            if(timerInterval) clearInterval(timerInterval);
            startTime = 0;
            timerInterval = null;
            
            statusDot.classList.remove('active');
            statusText.textContent = "ì¸¡ì • ì™„ë£Œ";

            progressBar.classList.remove('resizing');
            progressBar.style.width = '100%';
            progressBar.style.backgroundColor = "#00ff00";
            
            miniTimerDisplay.innerText = finalValue + " ms";
            miniTimerDisplay.style.color = "#00ff00";

            pushData(finalValue);
        }

        function resetUI() {
            displayData.fill(0); displayTimes.fill('-'); currentIndex = 0; logBuffer = [];
            updateGraphAndTable();
            progressBar.style.width = '0%';
            miniTimerDisplay.innerText = "0 ms";
        }

        function pushData(newValue) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ko-KR', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            displayData[currentIndex] = newValue;
            displayTimes[currentIndex] = timeStr;
            
            logBuffer.push({ id: logBuffer.length+1, time: now.toLocaleString(), value: newValue });
            
            updateGraphAndTable();
            currentIndex++;
            if (currentIndex >= 10) currentIndex = 0;
        }

        function updateGraphAndTable() {
            myChart.data.datasets[0].data = [...displayData]; myChart.update();
            const tableBody = document.querySelector('#dataTable tbody');
            // í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ë‹¨ìˆœí™”)
            const timeCells = document.getElementById('timeRow').children;
            const dataCells = document.getElementById('dataRow').children;
            
            for(let i=1; i<=10; i++) {
                timeCells[i].innerText = displayTimes[i-1];
                dataCells[i].innerText = displayData[i-1];
                
                // ê°•ì¡° í‘œì‹œ
                if(i-1 === (currentIndex === 0 ? 9 : currentIndex-1)) {
                    timeCells[i].classList.add('active-cell');
                    dataCells[i].classList.add('active-cell');
                } else {
                    timeCells[i].classList.remove('active-cell');
                    dataCells[i].classList.remove('active-cell');
                }
            }
        }

        // ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
        document.getElementById('btnConnect').onclick = connectSerial;
        
        document.getElementById('btnExport').onclick = function() {
            if (logBuffer.length === 0) return alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            const now = new Date();
            const fileName = `log_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
            
            let csv = "No,Time,Pulse(ms)\n";
            logBuffer.forEach(r => { csv += `${r.id},${r.time},${r.value}\n`; });
            
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = fileName + ".csv"; link.click();
        };

    </script>
</body>
</html>