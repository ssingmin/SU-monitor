<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Signal Monitor (Tagged CSV)</title>
    <style>
        /* === ì „ì²´ ë ˆì´ì•„ì›ƒ === */
        * { box-sizing: border-box; }
        body { 
            margin: 0; padding: 10px; 
            font-family: 'Segoe UI', sans-serif; 
            background: #f4f6f9; 
            height: 100vh; 
            display: flex; flex-direction: column; gap: 10px; 
            min-width: 900px; 
        }

        /* ë°•ìŠ¤ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .box { 
            background: white; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            padding: 10px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            transition: all 0.3s ease; 
        }
        
        /* ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
        .disabled-state {
            background-color: #f9f9f9 !important;
            filter: grayscale(100%);
            opacity: 0.6;
            pointer-events: none;
        }

        /* 1. ìƒë‹¨: ê·¸ë˜í”„ */
        .section-graph { flex: 7; position: relative; min-height: 0; }

        /* 2. ì¤‘ë‹¨: í…Œì´ë¸” */
        .section-table { flex: 2; display: flex; flex-direction: column; overflow: hidden; }
        .table-scroll { overflow-x: auto; height: 100%; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; text-align: center; table-layout: fixed; min-width: 700px; }
        th, td { border: 1px solid #ccc; padding: 6px; font-size: 13px; }
        td:first-child, th:first-child { background: #e9ecef; font-weight: bold; width: 80px; }
        thead th { background: #eaeff5; position: sticky; top: 0; }
        
        /* 3. í•˜ë‹¨: ë²„íŠ¼ ì˜ì—­ */
        .section-footer { 
            flex: 1; display: flex; align-items: center; justify-content: space-between; 
            gap: 10px; width: 100%;
        }
        .footer-left, .footer-right { flex: 0 0 auto; }
        
        /* ì¤‘ì•™ í…ŒìŠ¤íŠ¸ íŒ¨ë„ */
        .footer-center { 
            display: none; flex: 1; align-items: center;
            background: #fff; border: 1px solid #ccc; border-radius: 4px;
            padding: 5px 10px; height: 100%; gap: 10px; min-width: 0; 
        }

        /* 10ì¹¸ ê·¸ë¦¬ë“œ */
        .input-grid-container {
            display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; width: 100%; 
        }
        .test-input { 
            width: 100%; text-align: center; border: 1px solid #ddd; 
            border-radius: 3px; padding: 5px 0; font-size: 13px; font-weight: bold; color: #333;
        }
        .test-input:focus { border-color: #4CAF50; outline: 2px solid #a5d6a7; }

        /* ë²„íŠ¼ ë””ìì¸ */
        button { 
            height: 40px; padding: 0 15px; font-weight: bold; cursor: pointer; 
            border: 1px solid #999; background: white; border-radius: 4px; white-space: nowrap; 
        }
        button:hover { background: #eee; }

        #btnSend { background-color: #ff9800; color: white; border: none; padding: 0 25px; }
        #btnSend:hover { background-color: #f57c00; }
        
        .btn-connected { border-left: 5px solid #4CAF50 !important; color: #2e7d32 !important; background-color: white !important; }
        .btn-disconnected { border-left: 5px solid #999 !important; color: #888 !important; background-color: #f0f0f0 !important; }
        #btnExport { border-right: 5px solid #008CBA; }

        /* íŒì—… ìŠ¤íƒ€ì¼ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-window { background: white; width: 400px; padding: 20px; border-radius: 8px; display: flex; flex-direction: column; gap: 15px; }
        .modal-header { font-size: 18px; font-weight: bold; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .modal-footer { display: flex; justify-content: space-between; margin-top: 10px; }
        .modal-footer button { width: 45%; }
        .btn-ok { background-color: #007bff; color: white; border: none; }
        
        .port-list { list-style: none; padding: 0; margin: 0; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; }
        .port-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .port-item:hover { background-color: #f0f8ff; }
        .port-item.selected { background-color: #007bff; color: white; }

        .save-input-group { display: flex; flex-direction: column; gap: 5px; }
        .save-input-group label { font-size: 13px; font-weight: bold; color: #555; }
        .save-filename { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    </style>
</head>
<body>

    <div class="box section-graph disabled-state" id="graphArea">
        <canvas id="myChart"></canvas>
    </div>

    <div class="box section-table disabled-state" id="tableArea">
        <div style="font-weight:bold; margin-bottom:5px;">:: ì¸¡ì • ë°ì´í„°</div>
        <div class="table-scroll">
            <table id="dataTable">
                <thead>
                    <tr><th>ID</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th></tr>
                </thead>
                <tbody>
                    <tr id="dataRow"><td>ê°’</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="section-footer">
        <div class="footer-left">
            <button id="btnPort" class="btn-disconnected">âš™ï¸ í¬íŠ¸ ì—°ê²°</button>
        </div>

        <div class="footer-center" id="testPanel">
            <div class="input-grid-container">
                <input type="number" class="test-input" value="10">
                <input type="number" class="test-input" value="20">
                <input type="number" class="test-input" value="30">
                <input type="number" class="test-input" value="40">
                <input type="number" class="test-input" value="50">
                <input type="number" class="test-input" value="60">
                <input type="number" class="test-input" value="70">
                <input type="number" class="test-input" value="80">
                <input type="number" class="test-input" value="90">
                <input type="number" class="test-input" value="100">
            </div>
            <button id="btnSend">ğŸ“¤ SEND</button>
        </div>

        <div class="footer-right">
            <button id="btnExport">ğŸ’¾ ë¡œê·¸ ì €ì¥</button>
        </div>
    </div>

    <div class="modal-overlay" id="portModal">
        <div class="modal-window">
            <div class="modal-header">í¬íŠ¸ ì„¤ì • (Baud: 115200)</div>
            <ul class="port-list" id="portList"></ul>
            <div class="modal-footer">
                <button class="btn-cancel" id="btnPortCancel">Cancel</button>
                <button class="btn-ok" id="btnPortOk">OK</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="saveModal">
        <div class="modal-window">
            <div class="modal-header">ë¡œê·¸ ì €ì¥ ì„¤ì •</div>
            <div class="save-input-group">
                <label>íŒŒì¼ ì´ë¦„ (ìë™ ìƒì„±ë¨)</label>
                <input type="text" class="save-filename" id="fileNameInput" value="log_data">
            </div>
            <div style="font-size: 12px; color: #666; background: #f1f1f1; padding: 10px; border-radius: 4px;">
                â„¹ï¸ <b>[TEST]</b> ëª¨ë“œì¸ ê²½ìš°, ë°ì´í„° ëì— 'TEST' íƒœê·¸ê°€ ìë™ìœ¼ë¡œ ë¶™ìŠµë‹ˆë‹¤.
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="btnSaveCancel">Cancel</button>
                <button class="btn-ok" id="btnSaveOk">ì €ì¥ (Save)</button>
            </div>
        </div>
    </div>

    <script src="./jquery.min.js"></script>
    <script src="./chart.min.js"></script>

    <script>
        const ctx = document.getElementById('myChart');
        const myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'], 
                datasets: [{ label: 'Sensor Data', data: [0,0,0,0,0,0,0,0,0,0], backgroundColor: '#4472C4' }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // === ì „ì—­ ë³€ìˆ˜ ===
        let isConnected = false; 
        let selectedPort = null;
        let logBuffer = []; 

        function toggleUI(connected) {
            if (connected) {
                $('#graphArea, #tableArea').removeClass('disabled-state');
                $('#btnPort').removeClass('btn-disconnected').addClass('btn-connected');
                $('#btnPort').text('âœ… ì—°ê²°ë¨: ' + selectedPort);

                if(selectedPort.includes('TEST')) {
                    $('#testPanel').css('display', 'flex');
                } else {
                    $('#testPanel').hide();
                }
            } else {
                $('#graphArea, #tableArea').addClass('disabled-state');
                $('#testPanel').hide();
                $('#btnPort').removeClass('btn-connected').addClass('btn-disconnected');
                $('#btnPort').text('âš™ï¸ í¬íŠ¸ ì—°ê²° (í•´ì œë¨)');
            }
        }

        // [ì´ë²¤íŠ¸ 1] í¬íŠ¸ ë²„íŠ¼
        $('#btnPort').click(function() {
            if (isConnected) {
                if(confirm('ì—°ê²°ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    isConnected = false;
                    toggleUI(false);
                    logBuffer = []; // ì—°ê²° í•´ì œ ì‹œ ë²„í¼ ì´ˆê¸°í™”
                }
            } else {
                const ports = ['TEST (Virtual Mode)', 'COM1', 'COM2', 'COM3'];
                const $list = $('#portList');
                $list.empty();
                ports.forEach(port => $list.append(`<li class="port-item">${port}</li>`));
                $('#portModal').css('display', 'flex');
            }
        });

        // [ì´ë²¤íŠ¸ 2] SEND ë²„íŠ¼ (ë°ì´í„° ìƒì„±)
        $('#btnSend').click(function() {
            if(!isConnected) return;
            
            // 1. ê°’ ì½ê¸°
            let newValues = [];
            $('.test-input').each(function() {
                newValues.push(Number($(this).val()) || 0);
            });

            // 2. ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
            myChart.data.datasets[0].data = newValues;
            myChart.update();
            $('#dataRow td').each(function(index) {
                if (index > 0) $(this).text(newValues[index - 1]);
            });

            // 3. ë¡œê·¸ ì €ì¥ (íƒœê·¸ ë¡œì§ ì ìš©)
            const timestamp = new Date().toLocaleString();
            
            // [í•µì‹¬ ë¡œì§] í˜„ì¬ í¬íŠ¸ê°€ 'TEST'ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ íƒœê·¸ ë¶™ì„, ì•„ë‹ˆë©´ ë¹ˆ ë¬¸ìì—´
            const isTestMode = selectedPort && selectedPort.includes('TEST');
            const dataTag = isTestMode ? 'TEST' : ''; // ì‹¤ì œ í¬íŠ¸ë©´ ë¹ˆì¹¸

            logBuffer.push({ 
                time: timestamp, 
                values: newValues,
                tag: dataTag // ì €ì¥ë  íƒœê·¸
            });
            console.log(`Log saved: ${logBuffer.length} items (Tag: ${dataTag})`);
        });

        // [ì´ë²¤íŠ¸ 3] ë¡œê·¸ ì €ì¥
        $('#btnExport').click(function() {
            const now = new Date();
            const defaultName = `log_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
            $('#fileNameInput').val(defaultName);
            $('#saveModal').css('display', 'flex');
        });

        // íŒì—… ë‹«ê¸°
        $('#btnSaveCancel').click(() => $('#saveModal').hide());
        $('#btnPortCancel').click(() => $('#portModal').hide());

        // [ì´ë²¤íŠ¸ 4] íŒŒì¼ ì €ì¥ ì‹¤í–‰ (CSV ìƒì„±)
        $('#btnSaveOk').click(function() {
            const fileName = $('#fileNameInput').val() || 'log_data';
            
            if (logBuffer.length === 0) {
                alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                $('#saveModal').hide();
                return;
            }

            // 1. í—¤ë” ìƒì„± (ë§¨ ëì— Mode ì¶”ê°€)
            let csvContent = "Time,CH1,CH2,CH3,CH4,CH5,CH6,CH7,CH8,CH9,CH10,Mode\n";
            
            // 2. ë°ì´í„° í–‰ ìƒì„±
            logBuffer.forEach(row => {
                // ì‹œê°„, ê°’(1~10), íƒœê·¸(TEST or ë¹ˆì¹¸) ìˆœì„œë¡œ ì¡°í•©
                // ì˜ˆ: "2026.1.29..., 10, 20..., TEST"
                csvContent += `${row.time},${row.values.join(',')},${row.tag}\n`;
            });

            const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName + ".csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            $('#saveModal').hide();
            alert(`ì €ì¥ ì™„ë£Œ! (${logBuffer.length}ê±´)`);
        });

        // í¬íŠ¸ ì„¤ì • OK ë¡œì§
        $(document).on('click', '.port-item', function() {
            $('.port-item').removeClass('selected');
            $(this).addClass('selected');
            selectedPort = $(this).text();
        });
        $('#btnPortOk').click(function() {
            if (!selectedPort) { alert('í¬íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
            $('#portModal').hide();
            $.ajax({
                url: '/api/connect',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ port: selectedPort }),
                success: function(res) {
                    alert(res.message);
                    isConnected = true;
                    toggleUI(true);
                },
                error: function() { alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨'); }
            });
        });
    </script>
</body>
</html>