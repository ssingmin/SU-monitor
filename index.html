<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SR Monitor (Web Serial)</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* === ìŠ¤íƒ€ì¼ (ê¸°ì¡´ê³¼ ë™ì¼) === */
        * { box-sizing: border-box; }
        body { margin: 0; padding: 10px; font-family: 'Segoe UI', sans-serif; background: #f4f6f9; height: 100vh; display: flex; flex-direction: column; gap: 10px; }
        
        .box { background: white; border: 1px solid #ccc; border-radius: 4px; padding: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .disabled-state { background-color: #f9f9f9 !important; filter: grayscale(100%); opacity: 0.6; pointer-events: none; }
        
        .section-graph { flex: 6; position: relative; min-height: 200px; }
        .section-table { flex: 4; display: flex; flex-direction: column; overflow: hidden; gap: 0; padding-bottom: 0; } 
        .table-scroll { flex: 1; overflow: auto; border: 1px solid #ddd; display: flex; flex-direction: column; }
        
        table { width: 100%; height: 100%; border-collapse: collapse; text-align: center; table-layout: fixed; min-width: 600px; }
        th, td { border: 1px solid #ccc; padding: 4px; vertical-align: middle; font-size: 14px; font-weight: 600; white-space: nowrap; }
        thead th { background: #eaeff5; position: sticky; top: 0; z-index: 10; height: 35px; }
        td:first-child, th:first-child { background: #e9ecef; font-weight: bold; width: 100px; position: sticky; left: 0; z-index: 5;}
        
        .active-cell { background-color: #fff3cd !important; border: 2px solid #ffc107 !important; color: #d32f2f; }

        .stopwatch-panel {
            background-color: #222; padding: 5px; border-radius: 4px; border: 2px solid #444;
            height: 30px; margin-top: 5px; display: flex; align-items: center; position: relative; overflow: hidden;
        }
        .progress-bar {
            height: 100%; width: 0%; background-color: #0066ff; box-shadow: 0 0 10px #0066ff;
            transition: width 0.1s linear;
        }
        .progress-bar.resizing { transition: none !important; }

        .section-footer { flex: 0 0 60px; display: flex; align-items: center; justify-content: space-between; gap: 5px; width: 100%; }
        .footer-center { flex: 1; display: none; align-items: center; justify-content: center; background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 5px; height: 100%; gap: 10px; }

        #panelTestMode { display: flex; gap: 10px; align-items: center; width: 100%; justify-content: center; } 
        #panelArduinoMode { display: none; gap: 10px; align-items: center; width: 100%; justify-content: center; } 

        button { height: 45px; padding: 0 10px; font-size: 14px; font-weight: bold; cursor: pointer; border: 1px solid #999; background: white; border-radius: 4px; transition: all 0.2s; white-space: nowrap; }
        button:hover { background: #eee; }
        
        #btnConnect { border-left: 5px solid #007bff; color: #0056b3; }
        #btnTestMode { border-left: 5px solid #ff9800; color: #e65100; }
        #btnDisconnect { background-color: #6c757d; color: white; border: none; display: none; }
        #btnExport { border-right: 5px solid #17a2b8; color: #006064; }
        #btnReset { border-right: 5px solid #d32f2f; color: #c62828; }

        #btnManualTrigger { background-color: #607d8b; color: white; border: none; width: 100%; max-width: 200px; box-shadow: 0 4px #455a64; transform: translateY(0); }
        #btnManualTrigger:active, #btnManualTrigger.remote-active { background-color: #ff5722 !important; box-shadow: 0 0 #d84315 !important; transform: translateY(4px) !important; }

        .status-dot { width: 10px; height: 10px; background-color: #ccc; border-radius: 50%; display: inline-block; }
        .status-dot.active { background-color: #00ff00; box-shadow: 0 0 8px #00ff00; }
        .mini-timer { font-family: 'Courier New', monospace; font-size: 18px; font-weight: bold; color: #555; min-width: 70px; text-align: right; }
    </style>
</head>
<body>
    <div class="box section-graph disabled-state" id="graphArea"><canvas id="myChart"></canvas></div>
    <div class="box section-table disabled-state" id="tableArea">
        <div class="table-scroll">
            <table id="dataTable">
                <thead><tr><th>ID</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th></tr></thead>
                <tbody>
                    <tr id="timeRow"><td>Time</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
                    <tr id="dataRow"><td>Pulse</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
                </tbody>
            </table>
        </div>
        <div class="stopwatch-panel"><div id="progressBar" class="progress-bar"></div></div>
    </div>
    <div class="section-footer">
        <div style="display: flex; gap: 5px;">
            <button id="btnConnect">ğŸ”Œ ì¥ì¹˜ ì—°ê²°</button>
            <button id="btnTestMode">ğŸ§ª í…ŒìŠ¤íŠ¸</button>
            <button id="btnDisconnect">âŒ ì¢…ë£Œ</button>
        </div>
        <div class="footer-center" id="footerCenter">
            <div id="panelTestMode"><button id="btnManualTrigger">ğŸ–±ï¸ ê¾¹ ëˆ„ë¥´ì„¸ìš”</button></div>
            <div id="panelArduinoMode">
                <span style="font-weight:bold; color:#555; display:flex; align-items:center; gap:5px;">
                    <span class="status-dot" id="statusDot"></span><span id="statusText">ì‹ í˜¸ ëŒ€ê¸°...</span>
                </span>
            </div>
            <div style="width: 1px; height: 20px; background: #ddd;"></div><span id="miniTimerDisplay" class="mini-timer">0 ms</span>
        </div>
        <div style="display: flex; gap: 5px;">
            <button id="btnReset">ğŸ”„ ë¦¬ì…‹</button>
            <button id="btnExport">ğŸ’¾ ì €ì¥</button>
        </div>
    </div>

    <script>
        const ctx = document.getElementById('myChart');
        Chart.defaults.font.size = 14; 
        const myChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: ['1','2','3','4','5','6','7','8','9','10'], datasets: [{ label: 'Pulse Width (ms)', data: [0,0,0,0,0,0,0,0,0,0], backgroundColor: '#4472C4' }] },
            options: { responsive: true, maintainAspectRatio: false, animation: { duration: 0 } }
        });

        let port, reader, inputDone, outputStream, inputStream;
        let isConnected = false; let currentMode = 'NONE';
        let logBuffer = []; let displayData = [0,0,0,0,0,0,0,0,0,0]; let displayTimes = ['-','-','-','-','-','-','-','-','-','-'];
        let currentIndex = 0; let serialBuffer = "";
        let startTime = 0; let timerInterval = null; let currentMaxScale = 2000;
        const progressBar = document.getElementById('progressBar'); const miniTimerDisplay = document.getElementById('miniTimerDisplay');
        const statusDot = document.getElementById('statusDot'); const statusText = document.getElementById('statusText'); const btnTrigger = document.getElementById('btnManualTrigger');

        function setMode(mode) {
            currentMode = mode;
            if (mode === 'NONE') {
                $('#graphArea, #tableArea').addClass('disabled-state'); $('#footerCenter').hide();
                $('#btnConnect, #btnTestMode').show(); $('#btnDisconnect').hide(); resetUI();
            } else {
                $('#graphArea, #tableArea').removeClass('disabled-state'); $('#footerCenter').css('display', 'flex');
                $('#btnConnect, #btnTestMode').hide(); $('#btnDisconnect').show();
                if (mode === 'TEST') { $('#panelTestMode').css('display', 'flex'); $('#panelArduinoMode').hide(); }
                else { $('#panelTestMode').hide(); $('#panelArduinoMode').css('display', 'flex'); statusText.innerText = "ì‹ í˜¸ ëŒ€ê¸°..."; }
            }
        }

        async function connectSerial() {
            if (!("serial" in navigator)) return alert("Web Serial ë¯¸ì§€ì› ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
            try {
                port = await navigator.serial.requestPort(); await port.open({ baudRate: 115200 });
                const textDecoder = new TextDecoderStream(); inputDone = port.readable.pipeTo(textDecoder.writable); reader = textDecoder.readable.getReader();
                setMode('USB'); isConnected = true; readLoop();
            } catch (err) { console.error(err); alert("ì—°ê²° ì‹¤íŒ¨: " + err.message); setMode('NONE'); }
        }
        async function disconnectAll() {
            if (currentMode === 'USB') { if (reader) { await reader.cancel(); await inputDone.catch(() => {}); reader = null; inputDone = null; } if (port) { await port.close(); port = null; } }
            isConnected = false; setMode('NONE');
        }
        async function readLoop() {
            while (true) {
                const { value, done } = await reader.read(); if (done) { reader.releaseLock(); break; }
                if (value) { serialBuffer += value; if (serialBuffer.includes('\n')) { const lines = serialBuffer.split(/\r?\n/); serialBuffer = lines.pop(); for (const line of lines) { if (!line.trim()) continue; if (line.includes('[FALL]')) startMeasurementUI(); const pulseMatch = line.match(/Pulse Width:\s*(\d+)/); if (pulseMatch) stopMeasurementUI(parseInt(pulseMatch[1])); } } }
            }
        }

        function startMeasurementUI() {
            if (startTime !== 0) return; startTime = Date.now(); currentMaxScale = 2000;
            if(currentMode === 'USB') { statusDot.classList.add('active'); statusText.innerText = "ì¸¡ì • ì¤‘..."; } else { btnTrigger.classList.add('remote-active'); btnTrigger.innerText = "ì¸¡ì • ì¤‘..."; }
            progressBar.classList.add('resizing'); progressBar.style.width = '0%'; void progressBar.offsetWidth; progressBar.classList.remove('resizing'); progressBar.style.backgroundColor = "#0066ff"; miniTimerDisplay.style.color = "#0066ff";
            if(timerInterval) clearInterval(timerInterval); timerInterval = setInterval(() => { const elapsed = Date.now() - startTime; if (elapsed > currentMaxScale) { currentMaxScale *= 2; progressBar.classList.add('resizing'); } else { progressBar.classList.remove('resizing'); } let percent = (elapsed / currentMaxScale) * 100; if(percent > 100) percent = 100; progressBar.style.width = percent + '%'; miniTimerDisplay.innerText = elapsed + " ms"; }, 16);
        }
        function stopMeasurementUI(finalValue) {
            if(timerInterval) clearInterval(timerInterval); startTime = 0; timerInterval = null;
            if(currentMode === 'USB') { statusDot.classList.remove('active'); statusText.innerText = "ì¸¡ì • ì™„ë£Œ"; } else { btnTrigger.classList.remove('remote-active'); btnTrigger.innerText = "ğŸ–±ï¸ ê¾¹ ëˆ„ë¥´ì„¸ìš”"; }
            progressBar.classList.remove('resizing'); progressBar.style.width = '100%'; progressBar.style.backgroundColor = "#00ff00"; miniTimerDisplay.innerText = finalValue + " ms"; miniTimerDisplay.style.color = "#00ff00";
            pushData(finalValue);
        }

        $('#btnTestMode').click(function() { setMode('TEST'); });
        btnTrigger.addEventListener('mousedown', startMeasurementUI); btnTrigger.addEventListener('touchstart', function(e) { e.preventDefault(); startMeasurementUI(); });
        function finishTestTrigger() { if (startTime === 0 || currentMode !== 'TEST') return; const duration = Date.now() - startTime; stopMeasurementUI(duration); }
        btnTrigger.addEventListener('mouseup', finishTestTrigger); btnTrigger.addEventListener('mouseleave', finishTestTrigger); btnTrigger.addEventListener('touchend', finishTestTrigger);

        function resetUI() {
            displayData.fill(0); displayTimes.fill('-'); currentIndex = 0; logBuffer = [];
            updateGraphAndTable(); progressBar.style.width = '0%'; miniTimerDisplay.innerText = "0 ms";
        }
        function pushData(newValue) {
            const now = new Date(); const timeStr = now.toLocaleTimeString('ko-KR', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            displayData[currentIndex] = newValue; displayTimes[currentIndex] = timeStr;
            logBuffer.push({ id: logBuffer.length+1, time: now.toLocaleString(), value: newValue, mode: currentMode });
            updateGraphAndTable(); currentIndex++; if (currentIndex >= 10) currentIndex = 0;
        }
        
        // â˜…â˜…â˜… [í•µì‹¬ ìˆ˜ì •] í•˜ì´ë¼ì´íŠ¸ ë¡œì§ ìˆ˜ì • â˜…â˜…â˜…
        function updateGraphAndTable() {
            myChart.data.datasets[0].data = [...displayData]; myChart.update();
            const timeCells = document.getElementById('timeRow').children; const dataCells = document.getElementById('dataRow').children;
            for(let i=1; i<=10; i++) {
                timeCells[i].innerText = displayTimes[i-1]; dataCells[i].innerText = displayData[i-1];
                // ìˆ˜ì •ëœ ì¡°ê±´: í˜„ì¬ ì¸ë±ìŠ¤ì™€ ì¼ì¹˜í•˜ê³ , ë°ì´í„°ê°€ í•˜ë‚˜ë¼ë„ ë“¤ì–´ì˜¨ ìƒíƒœì¼ ë•Œë§Œ í•˜ì´ë¼ì´íŠ¸
                if((i - 1 === currentIndex) && (logBuffer.length > 0)) {
                    timeCells[i].classList.add('active-cell'); dataCells[i].classList.add('active-cell');
                } else {
                    timeCells[i].classList.remove('active-cell'); dataCells[i].classList.remove('active-cell');
                }
            }
        }

        $('#btnConnect').click(connectSerial); $('#btnDisconnect').click(disconnectAll); $('#btnReset').click(resetUI);
        $('#btnExport').click(function() { if (logBuffer.length === 0) return alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); const now = new Date(); const fileName = `log_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`; let csv = "No,Time,Pulse(ms),Mode\n"; logBuffer.forEach(r => { csv += `${r.id},${r.time},${r.value},${r.mode}\n`; }); const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = fileName + ".csv"; link.click(); });
    </script>
</body>
</html>